<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../img/favicon.ico">

    <title>xBIM</title>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom styles for this template -->
    <link href="../css/site.css" rel="stylesheet">

    <script src="../js/jquery.min.js"></script>

  </head>
<!-- NAVBAR
================================================== -->
  <body>

    <nav class="navbar navbar-inverse">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">xBIM</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          		   
	<ul class="nav navbar-nav">
        <li>
			<a href="../quick-start.html">Quick Start</a>
		</li>
        <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Examples <span class="caret"></span></a>
			
	<ul class="dropdown-menu">
        <li>
			<a href="../examples/basic-model-operations.html">Basic Model Operations</a>
		</li>
        <li>
			<a href="../examples/change-log-creation.html">Change Log Creation</a>
		</li>
        <li>
			<a href="../examples/creating-wexbim-file.html">Creating wexBIM file</a>
		</li>
        <li>
			<a href="../examples/insert-copy-function.html">Insert Copy Function</a>
		</li>
    </ul>

		</li>
        <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">License <span class="caret"></span></a>
			
	<ul class="dropdown-menu">
        <li>
			<a href="../license/license.html">License</a>
		</li>
        <li>
			<a href="../license/third-party-licenses.html">Third Party Licenses</a>
		</li>
    </ul>

		</li>
        <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">xBIM 4 <span class="caret"></span></a>
			
	<ul class="dropdown-menu">
        <li>
			<a href="../xbim-4/fast-upgrade-track.html">Fast Upgrade Track</a>
		</li>
        <li>
			<a href="../xbim-4/xbim-4-release-notes.html">xBIM 4 Release Notes</a>
		</li>
    </ul>

		</li>
    </ul>

        </div><!--/.nav-collapse -->
      </div>
    </nav>
	<div class="banner architecture">
		<h1>
		    The xBIM Toolkit <br />
		    <small>eXtensible Building Information Modelling </small>
		</h1>
	</div>

		<div class="container">

<h1>Insert Copy Function</h1>

<p>Merging and deleting entities in IFC models is a non-trivial task because IFC is not a hierarchical structure. It is a complex structure with 
potential cyclic relations an bi-directional navigation. Where it is not a problem to perform these tasks on a single entity (which you can imagine as a single line in STEP21 file)</p>

<pre><code>#144= IFCBUILDINGSTOREY('026ajlHVj1HBm_osQm7IDT',#47,'Lower Roof - Slab Level',$,$,#143,$,'Lower Roof - Slab Level',.ELEMENT.,3199.99999999704);
</code></pre>

<p>it becomes increasingly difficult once you want to isolate complete data islands defining the entity and you want to either delete it without side effects on other entities outside
the data island or you want to merge it so it blends into existing data without creating duplicities and inconsistencies. For these reasons we prefer the third option which is to 
choose what you want and to copy it over into an empty model. This is obviously potentially complex and complicated task as well but it is easier to keep 
things under your control at least. The core function which is now member of <code>IModel</code> interface is <code>InsertCopy()</code>:</p>

<div style="color:Black;background-color:White;"><pre>
T InsertCopy&lt;T&gt;(T toCopy, XbimInstanceHandleMap mappings, PropertyTranformDelegate propTransform, <span style="color:Blue;">bool</span> includeInverses, <span style="color:Blue;">bool</span> keepLabels);
</pre></div>

<p>Just as a brief description of all arguments are:</p>

<ul>
<li><em>toCopy</em>: Entity to be copied</li>
<li><em>mappings</em>: Mappings of previous inserts. There should always only be <strong>one instance for all insertions between two models</strong>.</li>
<li><em>propTransform</em>: Optional delegate which you can use to filter the content which will get coppied over or transform it before it gets copied. This is very powerful. </li>
<li><em>includeInverses</em>: Option to bring in all inverse entities. This is potentially dangerous as it might easily bring over almost entire model if not further constrained by propTransform delegate.</li>
<li><em>keepLabels</em>: Option to keep entity labels the same. It might be useful to keep labels the same sometimes. <strong>Never</strong> use this option if the target model is not a new model or if you insert objects from multiple models.</li>
</ul>

<p>From all these <code>PropertyTranformDelegate</code> might seem to be little bit cryptic. But it is a fundamental part of the approach described above because it allows to control extent of
the data being copied over. If you allow inverses and don't provide any additional filtering you will most probably end up with the model containing 98% of the original model
even if you just try to copy over a single wall. To use it properly you will need to understand structure of IFC very well. Here is a simple example of a powerful transform which 
will leave out all the geometry and placement and will only allow inverse relations describing type of the product and its properties. Geometry takes typically about 90% of the file
so if you are not interested in graphics or analyses based on geometry you can use this to create very small IFC file containing just descriptive data.</p>

<div style="color:Black;background-color:White;"><pre>
PropertyTranformDelegate semanticFilter = (property, parentObject) =&gt;
{
    <span style="color:Green;">//leave out geometry and placement</span>
    <span style="color:Blue;">if</span> (parentObject <span style="color:Blue;">is</span> IIfcProduct &amp;&amp;
        (property.PropertyInfo.Name == nameof(IIfcProduct.Representation) ||
        property.PropertyInfo.Name == nameof(IIfcProduct.ObjectPlacement)))
        <span style="color:Blue;">return</span> <span style="color:Blue;">null</span>;

    <span style="color:Green;">//leave out mapped geometry</span>
    <span style="color:Blue;">if</span> (parentObject <span style="color:Blue;">is</span> IIfcTypeProduct &amp;&amp; 
        property.PropertyInfo.Name == nameof(IIfcTypeProduct.RepresentationMaps))
        <span style="color:Blue;">return</span> <span style="color:Blue;">null</span>;

    <span style="color:Green;">//only bring over IsDefinedBy and IsTypedBy inverse relationships which will take over all properties and types</span>
    <span style="color:Blue;">if</span> (property.EntityAttribute.Order &lt; 0 &amp;&amp; !(
        property.PropertyInfo.Name == nameof(IIfcProduct.IsDefinedBy) ||
        property.PropertyInfo.Name == nameof(IIfcProduct.IsTypedBy)
        ))
        <span style="color:Blue;">return</span> <span style="color:Blue;">null</span>;

    <span style="color:Blue;">return</span> property.PropertyInfo.GetValue(parentObject, <span style="color:Blue;">null</span>);
};
</pre></div>

<p><code>PropertyTranformDelegate</code> takes two arguments where first is <code>ExpressMetaProperty</code> and second is an <code>object</code> which represents <code>IPersistEntity</code>.
<code>ExpressMetaProperty</code> is a cached object which is part of our own reflection meta model which we use for some data operations.
The delegate is used in other code which uses C# reflection to inspect the data and copy values over. If you don't specify a delegate <code>InsertCopy()</code>
will use all properties in the entity and copy them over. </p>

<div style="color:Black;background-color:White;"><pre>
<span style="color:Blue;">using</span> Xbim.Common;
<span style="color:Blue;">using</span> Xbim.Ifc;
<span style="color:Blue;">using</span> Xbim.Ifc4.Interfaces;

<span style="color:Blue;">namespace</span> BasicExamples
{
    <span style="color:Blue;">class</span> InsertCopy
    {
        <span style="color:Blue;">public</span> <span style="color:Blue;">void</span> CopyWallsOver()
        {
            <span style="color:Blue;">const</span> <span style="color:Blue;">string</span> original = <span style="color:#A31515;">&quot;SampleHouse.ifc&quot;</span>;
            <span style="color:Blue;">const</span> <span style="color:Blue;">string</span> inserted = <span style="color:#A31515;">&quot;SampleHouseWalls.ifc&quot;</span>;

            PropertyTranformDelegate semanticFilter = (property, parentObject) =&gt;
            {
                <span style="color:Green;">//leave out geometry and placement</span>
                <span style="color:Blue;">if</span> (parentObject <span style="color:Blue;">is</span> IIfcProduct &amp;&amp;
                    (property.PropertyInfo.Name == nameof(IIfcProduct.Representation) ||
                    property.PropertyInfo.Name == nameof(IIfcProduct.ObjectPlacement)))
                    <span style="color:Blue;">return</span> <span style="color:Blue;">null</span>;

               <span style="color:Green;">//leave out mapped geometry</span>
               <span style="color:Blue;">if</span> (parentObject <span style="color:Blue;">is</span> IIfcTypeProduct &amp;&amp; 
                    property.PropertyInfo.Name == nameof(IIfcTypeProduct.RepresentationMaps))
                    <span style="color:Blue;">return</span> <span style="color:Blue;">null</span>;



                <span style="color:Green;">//only bring over IsDefinedBy and IsTypedBy inverse relationships which will take over all properties and types</span>
                <span style="color:Blue;">if</span> (property.EntityAttribute.Order &lt; 0 &amp;&amp; !(
                    property.PropertyInfo.Name == nameof(IIfcProduct.IsDefinedBy) ||
                    property.PropertyInfo.Name == nameof(IIfcProduct.IsTypedBy)
                    ))
                    <span style="color:Blue;">return</span> <span style="color:Blue;">null</span>;

                <span style="color:Blue;">return</span> property.PropertyInfo.GetValue(parentObject, <span style="color:Blue;">null</span>);
            };

            <span style="color:Blue;">using</span> (<span style="color:Blue;">var</span> model = IfcStore.Open(original))
            {
                <span style="color:Blue;">var</span> walls = model.Instances.OfType&lt;IIfcWall&gt;();
                <span style="color:Blue;">using</span> (<span style="color:Blue;">var</span> iModel = IfcStore.Create(model.IfcSchemaVersion, XbimStoreType.InMemoryModel))
                {
                    <span style="color:Blue;">using</span> (<span style="color:Blue;">var</span> txn = iModel.BeginTransaction(<span style="color:#A31515;">&quot;Insert copy&quot;</span>))
                    {
                        <span style="color:Green;">//single map should be used for all insertions between two models</span>
                        <span style="color:Blue;">var</span> map = <span style="color:Blue;">new</span> XbimInstanceHandleMap(model, iModel);

                        <span style="color:Blue;">foreach</span> (<span style="color:Blue;">var</span> wall <span style="color:Blue;">in</span> walls)
                        {
                            iModel.InsertCopy(wall, map, semanticFilter, <span style="color:Blue;">true</span>, <span style="color:Blue;">false</span>);
                        }

                        txn.Commit();
                    }

                    iModel.SaveAs(inserted);
                }
            }
        }
    }
}
</pre></div>

    </div>
	    


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>
